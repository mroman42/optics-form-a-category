#+Title: Optics form a category, graphically
#+Author: Mario Rom√°n
#+latex_class: article
#+latex_class_options: [11pt, dvipsnames]
#+options: todo:nil toc:nil ':t

#+latex_header: \pdfoutput=1
#+latex_header: \usepackage{latex/macros}
#+latex_header: \usepackage{latex/header}
#+latex_header: \usepackage{latex/optics}

* Abstract :ignore:
#+begin_abstract
This is a short note that slightly extends the graphical calculus Mitchell Riley cite:riley18 introduced for monoidal optics to the general case of arbitrary optics.  This graphical calculus is then used to prove that optics for a strong monoidal action form a category.  Compare these simple proofs with unintuitive formal derivations of this same author [[cite:roman19][\S 3.1]].
#+end_abstract

* Optics
In functional programming, *optics* are a compositional representation
of bidirectional data accessors, provided by libraries such as
cite:kmett15.  Optics are divided into various /families/; each one of them
encapsulating some data accessing pattern.  For instance, /lenses/
access subfields, /prisms/ pattern match, and /traversals/ iterate over containers.

#+begin_definition
Let $\oslash \colon \M \times \C \to \C$ be a strong monoidal functor and let $A,B,S,T \in \C$.  An *optic* from $(A,B)$ to $(S,T)$
is an element of the set
\[ \Optic_{\oslash}\left((S,T), (A,B)\right) \coloneqq
\int^{M \in \M} \C(S, M \oslash A) \times \C(M \oslash B, T).
\]
In other words, optics are pairs $\left\langle l \mid r \right\rangle$, where $l \in \C(S, M \oslash A)$ and $r \in \C(M \oslash B, T)$,
quotiented by the equivalence relation generated by
$\left\langle (\alpha \oslash \id) \circ l \mid r \right\rangle \sim \left\langle l \mid r \circ (\alpha \oslash \id) \right\rangle$ for every $\alpha \in \M(M,N)$.
#+end_definition

* The category of optics
In order to depict optics, we shall employ the graphical calculus for bicategories cite:marsden14 and specifically for the bicategory of categories $\Cat$, in which 0-cells are categories, 1-cells are functors and 2-cells are natural transformations.  We shall also make use of monoidal functor boxes cite:mellies06 on the monoidal category $\Cat(\C,\C)$ for a fixed category $\C$.

Let us describe the specific elements that come into play when representing optics. The action $(\oslash) \colon \M \times \C \to \C$  will be seen as a functor $\M \to [\C,\C]$ represented by a functor box. Objects on the category $\C$ will be represented as functors (wires) from $\mathbf{1}$, the terminal category.  The different categories we are using are usually represented by coloring the regions. However, given that ambiguity will not be a problem, we prefer to avoid coloring the regions in order to make diagrams clearer. After these considerations, an optic $\left\langle l \mid r \right\rangle \in \Optic_\oslash((A,B),(S,T))$
can be depicted as the pair of morphisms $l \colon S \to M \oslash A$ and $r \colon M \oslash B \to T$,
\[\includegraphics[scale=0.2]{./images/optic.png}\]
where the naturality condition quotients optics by the equivalence relation given by 
any natural transformation $f \colon M \to N$ travelling through the upper wire.
\begin{align*}
\raisebox{-.4\height}{\includegraphics[scale=0.18]{./images/relation1.png}}
\sim
\raisebox{-.4\height}{\includegraphics[scale=0.18]{./images/relation2.png}}
\end{align*}

#+begin_remark
There exist some other graphical calculi for optics on the literature cite:hedges17,boisseau19.  This proposal is not to be understood as a graphical calculus for categories of optics but a way of understanding what optics are in the already existing language of bicategories.
#+end_remark

* Categories of optics :ignore:
We have defined optics in full generality, allowing $\oslash$ to be an
arbitrary functor from an arbitrary category $\M$. However, the most
interesting case, and the one commonly studied when one talks about optics, is
the one where $\M$ is a monoidal category and the functor is a /monoidal action/.
In that case, we can endow optics over an action with category structure.

#+begin_definition
An action $\oslash \colon \M \times \C \to \C$ from a monoidal category $\M$ is a (strong) monoidal 
action when the associated functor $\M \to [\C, \C]$ is strong monoidal.  In other words,
it comes equipped with natural isomorphisms $\varepsilon_A \colon A \to I \oslash A$ and
$\mu_{M,N,A} \colon M
\oslash N \oslash A \to M \otimes N \oslash A$.
#+attr_latex: :width 5cm :placement [!H]
[[./images/monoidalbox.png]] 
These isomorphisms must satisfy the usual unitality and associativity 
requirements, which can be translated into the graphical calculus as saying
that the following equalities between diagrams hold.
#+attr_latex: :width 8cm :placement [!H]
[[./images/laxmonoidal.png]]
#+end_definition

#+begin_proposition
Let $(\oslash) \colon \M \times \C \to \C$ be a monoidal action. $\Optic_{\oslash}$ can be given category structure.
#+end_proposition
#+begin_proof
We start by proving that $\Optic_{\oslash}$ defines a category. Let 
\[\left\langle l_1 \mid r_1 \right\rangle \in \Optic_{\oslash}((A,B),(S,T)),
\quad\mbox{ and }\quad
\left\langle l_2 \mid r_2 \right\rangle \in \Optic_{\oslash}((X,Y),(A,B)),\] 
we define their composition in $\Optic((X,Y),(S,T))$ to be the following.
\[ \includegraphics[scale=0.2]{./images/composition.png} \]
This is well defined, as it preserves the equivalence relation.
\begin{align*}
& \includegraphics[scale=0.2]{./images/welldefined1.png} \\
= & \quad\mbox{(Naturality)} \\
& \includegraphics[scale=0.2]{./images/welldefined2.png} \\
= & \quad\mbox{(Equivalence relation)} \\
& \includegraphics[scale=0.2]{./images/welldefined3.png} \\
= & \quad\mbox{(Naturality)} \\
& \includegraphics[scale=0.2]{./images/welldefined4.png}
\end{align*}
The identity, on the other hand, is defined as follows.
\[\includegraphics[scale=0.15]{./images/identity.png}\]
Composing with the identity leaves the optic unchanged on both sides.
\begin{align*}
& \includegraphics[scale=0.15]{./images/neutral1.png} \\
= & \quad\mbox{(Topology)} \\
&  \includegraphics[scale=0.2]{./images/optic.png} \\
= & \quad\mbox{(Topology)} \\
& \includegraphics[scale=0.15]{./images/neutral2.png}
\end{align*}
We also prove associativity of composition.
\[\begin{align*}
& \includegraphics[scale=0.15]{./images/distributive1.png} \\
= & \quad\mbox{(Topology)} \\
& \includegraphics[scale=0.15]{./images/distributive2.png} \\
\end{align*}\]

#+end_proof

* Identity-on-objects embedding
An important, and possibly overlooked detail on the theory of optics, is
the existence of an identity-on-objects functor that embeds the
category $\C \times \C^{op}$ into $\Optic_{\oslash}$.  Monoids in the
bicategory of profunctors, which we will call /promonads/, can be
characterized to be equivalent to identity-on-objects functors. This
is to say that the following result makes $\Optic_{\oslash}$ a promonad.

#+begin_theorem
There exists an identity-on-objects functor $i \colon \C \times \C^{op} \to \Optic_{\oslash}$.
#+end_theorem
#+begin_proof
The embedding of a morphism of $\C \times \C^{op}$ given by a pair of functions $(f,g)$
is determined by the following diagram.
\begin{align*}
\includegraphics[scale=0.2]{./images/embedding.png}
\end{align*}
Using the graphical calculus, it is particularly easy to check that this defines in fact a functor.
#+end_proof

* Lawful optics
Optics, and in particular lenses, were originally considered to be
particularly well-behaved if they were to satisfy some extra axioms.
In practice, these axioms are used to ensure that optics behave as the
final user expects them to (the /lens/ library cite:kmett15 examplifies
this convention).  An important contribution in the work of Riley
[[cite:riley18][\S 3]] is to characterize the laws of optics as the axioms of a
comonoid homomorphism.  For completeness, we will depict them following
the graphical calculus we just introduced.

#+begin_definition
cite:riley18 Consider a type-invariant three-leg variant of optics where elements are the elements of a coend given as follows.  Elements of this type can be written as triples quotiented by the equivalence relation of the coend, and depicted as triples of diagrams.
\[\Optic^2_{\oslash}(S,A) \coloneqq 
\int^{M_1,M_2 \in \M}
\C(S, M_1 \oslash A) \times \C(M_1 \oslash A, M_2 \oslash A) \times \C(M_2 \oslash A, S).\]
#+end_definition

#+begin_definition
An optic $\left\langle l \mid r \right\rangle$ is *lawful* when $r \circ l = \id$ and $\left\langle l \mid r \circ l \mid r \right\rangle = \left\langle l \mid \id \mid r \right\rangle$. That is to say that the
following diagrammatic equations hold.
\begin{align*}
& \includegraphics[scale=0.12]{./images/lawfuloptic.png} \\
\end{align*}
#+end_definition


#+begin_proposition
Assume $(\oslash)$ is a monoidal action. Lawful optics form a subcategory of the category of optics.
#+end_proposition
#+begin_proof
We prove that the composition of two lawful optics is again a lawful optic.
\begin{align*}
& \includegraphics[scale=0.15]{./images/lawful-step1.png} \\
= & \\
& \includegraphics[scale=0.15]{./images/lawful-step2.png} \\
= & \\
& \includegraphics[scale=0.15]{./images/lawful-step3.png} \\
= & \\
& \includegraphics[scale=0.15]{./images/lawful-step4.png} \\
\end{align*}
#+end_proof

* References :ignore:
bibliographystyle:alpha
bibliography:~/latex/bibliography.bib
